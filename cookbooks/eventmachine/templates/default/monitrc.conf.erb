# monitor the eventmachine workers
<% (@num_workers).times do |num| %>
<% pid_file = "/var/run/zz/em_#{@app_name}_#{num}.pid" %>
<% start_cmd = "cd #{current_dir} && RAILS_ENV=#{@rails_env} sudo #{@current_dir}/emstart.rb start -n #{num} -g #{@group} -u #{@user}" %>
<% stop_cmd = "/usr/bin/zzscripts/zz_cmds_stop.rb -p #{pid_file} -t 5" %>
check process eventmachine_<%= @app_name %>_<%= num %>
  with pidfile <%=pid_file%>
  start program = "/bin/su - <%=@user%> -c '<%=start_cmd%>'"
  stop program = "/bin/su - <%=@user%> -c '<%=stop_cmd%>'"
  # force new instance to start if too much memory
  if totalmem > 120.0 MB for 6 cycles then restart
  group eventmachine_<%= @app_name %>
<% end %>
